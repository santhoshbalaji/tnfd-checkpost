<div class="log-detail-page">
  @if (isLoading()) {
    <div class="status-container loading">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Loading log details...</p>
    </div>
  } @else if (dailyLog(); as log) {
    <!-- Header/Banner -->
    <section class="banner">
      <div class="banner-header">
        <div class="navigation-group">
          <a [routerLink]="['/home/detail', checkpostId()]" class="btn-circular">
            <i class="pi pi-arrow-left"></i>
          </a>
          <span class="location-badge">Log Entry Details</span>
        </div>
        
        <div class="header-main">
          <div class="title-section">
            <h1>Log: {{ log.logDate | date:'fullDate' }}</h1>
            <div class="stats-row">
              <p class="subtitle">
                <i class="pi pi-car"></i>
                {{ log.vehiclesCheckedCount }} Vehicles Checked
              </p>
              <p class="subtitle">
                <i class="pi pi-folder"></i>
                {{ log.casesRegisteredCount }} Cases Registered
              </p>
              <p-button icon="pi pi-pencil" [text]="true" severity="secondary" (onClick)="openEditLogModal()" size="small" label="Edit Counts" />
            </div>
          </div>
          <div class="actions">
            <p-button label="Register New Case" icon="pi pi-plus" (onClick)="showCaseModal()" styleClass="btn-primary" />
          </div>
        </div>
      </div>
    </section>

    <!-- Cases Table -->
    <section class="records-section">
      <div class="card records-card">
        <div class="card-title">
          <h2>Registered Cases</h2>
          <p>Detailed records for investigations conducted on this date</p>
        </div>

        <p-table [value]="cases()" [paginator]="true" [rows]="10" styleClass="p-datatable-sm history-table">
          <ng-template pTemplate="header">
            <tr>
              <th>Vehicle Reg #</th>
              <th>Owner</th>
              <th>Driver</th>
              <th>Engine Number</th>
              <th style="width: 8rem">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-case>
            <tr>
              <td><strong>{{ case.vehicleRegNumber }}</strong></td>
              <td>
                <div class="user-info">
                  <span>{{ case.ownerName }}</span>
                  <small>{{ case.ownerNumber }}</small>
                </div>
              </td>
              <td>
                <div class="user-info">
                  <span>{{ case.driverName }}</span>
                  <small>{{ case.driverNumber }}</small>
                </div>
              </td>
              <td>{{ case.engineNumber }}</td>
              <td>
                <div class="flex gap-2">
                  <p-button icon="pi pi-pencil" [text]="true" severity="info" (onClick)="editCase(case)" />
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="empty-state">
                <i class="pi pi-folder-open"></i>
                <p>No cases registered for this log entry.</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </section>
  }

  <!-- Case Registration Modal -->
  <p-dialog 
    [header]="editingCaseId() ? 'Edit Case Investigation' : 'Register Case Investigation'" 
    [(visible)]="isCaseModalVisible" 
    [modal]="true" 
    [draggable]="false" 
    [resizable]="false"
    styleClass="modern-dialog">
    
    <div class="log-form">
      <form [formGroup]="caseForm">
        <div class="dialog-intro">
          <div class="dialog-title-block">
            <h3 class="dialog-title">{{ editingCaseId() ? 'Update Case Details' : 'New Case Record' }}</h3>
            <p class="dialog-subtitle">Add or update the vehicle and investigation details from {{ dailyLog()?.logDate | date:'mediumDate' }}.</p>
          </div>
          <div class="dialog-meta-block">
            <span class="pill">TNFD Record</span>
            <span class="meta-value">Case Entry</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-field">
            <label>Vehicle Reg Number</label>
            <input pInputText formControlName="vehicleRegNumber" placeholder="TN 00 AA 0000" />
          </div>
          <div class="form-field">
            <label>Engine Number</label>
            <input pInputText formControlName="engineNumber" placeholder="Engine ID" />
          </div>
        </div>

        <div class="section-divider">
          <span class="divider-line"></span>
          <h3>Section 1: Identity</h3>
        </div>

        <div class="form-grid">
          <div class="form-field">
            <label>Owner Name</label>
            <input pInputText formControlName="ownerName" />
          </div>
          <div class="form-field">
            <label>Owner Mobile</label>
            <input pInputText formControlName="ownerNumber" />
          </div>
          <div class="form-field">
            <label>Owner License #</label>
            <input pInputText formControlName="ownerLicense" />
          </div>
          <div class="checkbox-field" style="margin-top: 2rem;">
            <input type="checkbox" id="ownerIsDriver" formControlName="ownerIsDriver" />
            <label for="ownerIsDriver">Owner is the Driver</label>
          </div>
        </div>

        @if (!caseForm.get('ownerIsDriver')?.value) {
          <div class="form-grid">
            <div class="form-field">
              <label>Driver Name</label>
              <input pInputText formControlName="driverName" />
            </div>
            <div class="form-field">
              <label>Driver Mobile</label>
              <input pInputText formControlName="driverNumber" />
            </div>
            <div class="form-field">
              <label>Driver License #</label>
              <input pInputText formControlName="driverLicense" />
            </div>
          </div>
        }

        <div class="section-divider">
          <span class="divider-line"></span>
          <h3>Section 2: Seized Items</h3>
        </div>

          <div formArrayName="seizedItems" class="seized-items-grid">
            <ng-container *ngFor="let entry of seizedItemControls; let index = index">
              <div
                [formGroupName]="index"
                class="seized-item-row"
                [class.has-custom-label]="entry.get('itemId')?.value === 'others'"
              >
              <div class="form-field">
                <label>Seized Item</label>
                <select formControlName="itemId">
                  <option value="" disabled>Select an item</option>
                  <option *ngFor="let option of seizedItemOptions()" [value]="option.$id">
                    {{ option.name }} @if (option.description) { - {{ option.description }} }
                  </option>
                  <option value="others">Other item (specify)</option>
                </select>
              </div>
              @if (entry.get('itemId')?.value === 'others') {
                <div class="form-field custom-label-field">
                  <label>Custom Item Name</label>
                  <input pInputText formControlName="customLabel" placeholder="Describe the seized item" />
                </div>
              }
              <div class="form-field">
                <label>Quantity</label>
                <input type="number" pInputText formControlName="quantity" min="1" />
              </div>
              <div class="form-field">
                <label>Weight (Kgs)</label>
                <input type="number" pInputText formControlName="weight" min="0" step="0.01" placeholder="Optional" />
              </div>
              <div class="form-field">
                <label>Approximate Value (â‚¹)</label>
                <input type="number" pInputText formControlName="value" min="0" />
              </div>
              <div class="form-actions">
                @if (seizedItemsArray.length > 1) {
                  <p-button icon="pi pi-times" [text]="true" (onClick)="removeSeizedItemEntry(index)" />
                }
              </div>
            </div>
          </ng-container>
        </div>

        <div class="form-footer spaced">
          <p-button label="Add Another Item" icon="pi pi-plus" (onClick)="addSeizedItemEntry()" [text]="true" />
        </div>

        <div class="section-divider">
          <span class="divider-line"></span>
          <h3>Section 3: Action & Reference</h3>
        </div>

        <div class="form-grid">
          <div class="form-field">
            <label>Case Number (ID)</label>
            <input pInputText formControlName="caseNumber" placeholder="OR-00/2026" />
          </div>
          <div class="form-field">
            <label>Accused Person Count</label>
            <input type="number" pInputText formControlName="accusedPersonCount" min="0" />
          </div>
          <div class="form-field">
            <label>Hand Overed To (Name)</label>
            <input pInputText formControlName="actionTakenName" placeholder="Recipient Name" />
          </div>
          <div class="form-field">
            <label>Recipient Phone</label>
            <input pInputText formControlName="actionTakenPhone" placeholder="Mobile Number" />
          </div>
          <div class="form-field">
            <label>Hand Over Recipient Designation *</label>
            <input pInputText formControlName="actionTakenDesignation" placeholder="Designation" required />
          </div>
        </div>

        <div class="form-footer">
          <p-button label="Cancel" (onClick)="isCaseModalVisible.set(false)" [text]="true" severity="secondary" />
          <p-button [label]="editingCaseId() ? 'Update Case Record' : 'Save Case Record'" [loading]="isSavingCase()" icon="pi pi-check" (onClick)="saveCase()" [disabled]="caseForm.invalid" />
        </div>
      </form>
    </div>
  </p-dialog>
</div>

<!-- Edit Log Counts Dialog -->
<p-dialog 
  header="Update Shift Statistics" 
  [(visible)]="isLogEditModalVisible" 
  [modal]="true" 
  [draggable]="false" 
  [resizable]="false"
  styleClass="modern-dialog">
  
  <div class="log-form">
    <form [formGroup]="logEditForm">
      <div class="dialog-intro">
        <div class="dialog-title-block">
          <h3 class="dialog-title">Shift Audit</h3>
          <p class="dialog-subtitle">Correct vehicle and case counts recorded for this shift.</p>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-field">
          <label>Total Vehicles Checked</label>
          <input type="number" pInputText formControlName="vehiclesCheckedCount" />
        </div>
      </div>

      <div class="form-footer">
        <p-button label="Dismiss" (onClick)="isLogEditModalVisible.set(false)" [text]="true" severity="secondary" />
        <p-button label="Update Counts" [loading]="isUpdatingLog()" icon="pi pi-refresh" (onClick)="saveLogEdit()" [disabled]="logEditForm.invalid" />
      </div>
    </form>
  </div>
</p-dialog>

<p-toast />
