<div class="profile-page">
  <header class="profile-header panel card">
    <div>
      <p class="eyebrow">Profile</p>
      <h1>{{ auth.userName() }}</h1>
      <p class="subtitle">Review access details and rotate your password securely.</p>
    </div>
    <div class="profile-badges">
      @if (auth.isAdmin()) {
        <span class="badge badge--admin">Admin access</span>
      } @else if (auth.hasCircleAccess()) {
        <span class="badge badge--circle">Circle contributor</span>
      } @else {
        <span class="badge">Viewer</span>
      }
    </div>
  </header>

  <div class="profile-grid">
    <section class="panel card profile-overview">
      <div class="panel-title">
        <h2>Account details</h2>
        <p class="subtitle">Information fetched from Appwrite for the active session.</p>
      </div>
      <div class="profile-details">
        <div class="detail-row">
          <span class="detail-label">Name</span>
          <strong>{{ auth.userName() }}</strong>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email</span>
          <span>{{ auth.userEmail() }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Registered</span>
          <span>{{ formatTimestamp(auth.user()?.registration) }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Last seen</span>
          <span>{{ formatTimestamp(auth.user()?.accessedAt) }}</span>
        </div>
        <div class="detail-row detail-row--wrap">
          <span class="detail-label">Circles</span>
          <div class="label-row">
            @if (!hasCircles()) {
              <span class="helper">No circles assigned.</span>
            } @else {
              @for (circle of auth.circleLabels(); track circle) {
                <span class="label-pill">{{ circle }}</span>
              }
            }
          </div>
        </div>
      </div>
    </section>

    <section class="panel card password-panel">
      <div class="panel-title">
        <h2>Change password</h2>
        <p class="subtitle">Passwords must be at least 8 characters long.</p>
      </div>

      @if (feedback()) {
        <div
          class="feedback"
          [class.error]="feedback()?.type === 'error'"
          [class.success]="feedback()?.type === 'success'"
          role="status"
          aria-live="polite">
          <span>{{ feedback()?.message }}</span>
          <button type="button" class="feedback-close" (click)="feedback.set(null)">âœ•</button>
        </div>
      }

      <form [formGroup]="passwordForm" class="password-form" (ngSubmit)="handlePasswordUpdate()">
        <div class="form-field">
          <label for="current-password">Current password</label>
          <input id="current-password" type="password" formControlName="currentPassword" autocomplete="current-password">
          <p class="helper">Provide your existing password unless the account is managed through a non-password flow.</p>
        </div>
        <div class="form-field">
          <label for="new-password">New password</label>
          <input id="new-password" type="password" formControlName="newPassword" autocomplete="new-password">
          @if (passwordForm.controls.newPassword.invalid && passwordForm.controls.newPassword.touched) {
            <span class="error-text">Password must be at least 8 characters.</span>
          }
        </div>
        <div class="form-field">
          <label for="confirm-password">Confirm password</label>
          <input id="confirm-password" type="password" formControlName="confirmPassword" autocomplete="new-password">
          @if (passwordForm.controls.confirmPassword.invalid && passwordForm.controls.confirmPassword.touched) {
            <span class="error-text">Please confirm your new password.</span>
          }
        </div>
        <div class="form-actions">
          <p-button
            type="submit"
            label="Update password"
            [loading]="isSubmitting()"
            [disabled]="isSubmitting()"></p-button>
        </div>
      </form>
    </section>
  </div>
</div>
