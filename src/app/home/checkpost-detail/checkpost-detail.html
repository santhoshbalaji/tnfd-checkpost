<div class="detail-page">
  @if (isLoading()) {
    <div class="status-container loading">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Loading details...</p>
    </div>
  } @else if (error()) {
    <div class="status-container error">
      <div class="error-box">
        <i class="pi pi-exclamation-circle"></i>
        <span>{{ error() }}</span>
      </div>
    </div>
  } @else if (checkpost(); as cp) {
    <!-- Hero Banner -->
    <section class="banner">
      <div class="banner-header">
        <div class="navigation-group">
          <a routerLink="/home/checkposts" class="btn-circular">
            <i class="pi pi-arrow-left"></i>
          </a>
          <span class="location-badge">{{ cp.circle }} Circle</span>
        </div>
        
          <div class="header-main">
          <div class="title-section">
            <h1>{{ cp.name }}</h1>
            <p class="subtitle">
              <i class="pi pi-map-marker"></i>
              {{ cp.division }} Division, {{ cp.range }} Range
            </p>
          </div>
          <div class="actions">
            <p-button label="Add Daily Log" icon="pi pi-plus" (onClick)="showLogModal()" styleClass="btn-primary" />
            <p-button
              label="Edit Details"
              icon="pi pi-pencil"
              styleClass="p-button-outlined"
              (onClick)="showEditDialog()"
            ></p-button>
          </div>
        </div>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <span class="item-label">Contact Number</span>
          <p class="item-value">{{ cp.phoneNumber }}</p>
        </div>
        <div class="info-item">
          <span class="item-label">Address</span>
          <p class="item-value">{{ cp.address }}</p>
        </div>
        <div class="info-item">
          <span class="item-label">Registered Since</span>
          <p class="item-value">{{ cp.$createdAt | date:'mediumDate' }}</p>
        </div>
      </div>
    </section>

    <!-- Logs History -->
    <section class="records-section">
      <div class="card records-card">
        <div class="card-title">
          <h2>Operational History</h2>
          <p>Historical data for vehicle checks and registrations</p>
        </div>
        
        <p-table [value]="dailyLogs()" [paginator]="true" [rows]="10" styleClass="p-datatable-sm history-table">
          <ng-template pTemplate="header">
            <tr>
              <th>Entry Date</th>
              <th>Vehicles Checked</th>
              <th>Vehicles Passed</th>
              <th>Cases Documented</th>
              <th class="col-action">Details</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-log>
            <tr>
              <td class="cell-date">{{ log.logDate | date:'fullDate' }}</td>
              <td>{{ log.vehiclesCheckedCount }}</td>
              <td>{{ log.vehiclesPassedCount ?? 0 }}</td>
              <td>
                <span class="case-chip" [class.has-cases]="log.casesRegisteredCount > 0">
                  {{ log.casesRegisteredCount }} Cases
                </span>
              </td>
              <td class="col-action">
                <p-button icon="pi pi-chevron-right" [text]="true" severity="secondary" [routerLink]="['log', log.$id]" />
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="empty-state">
                <i class="pi pi-inbox"></i>
                <p>No activity logs found for this checkpost.</p>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </section>

    <!-- Log Submission Dialog -->
    <p-dialog 
      header="Register Daily Entry" 
      [(visible)]="isLogModalVisible" 
      [modal]="true" 
      [draggable]="false" 
      [resizable]="false"
      styleClass="modern-dialog">
      
      <div class="log-form">
        <div class="dialog-intro">
          <div class="dialog-title-block">
            <h3 class="dialog-title">Daily Log for {{ cp.name }}</h3>
            <p class="dialog-subtitle">Capture how many vehicles you inspected and how many needed follow-up.</p>
          </div>
          <div class="dialog-meta-block">
            <span class="pill">{{ cp.circle }} Circle</span>
            <span class="meta-value">{{ logForm.get('logDate')?.value | date:'fullDate' }}</span>
          </div>
        </div>

        <form [formGroup]="logForm">
          <div class="form-grid">
            <div class="form-field">
              <label>Total Vehicles Checked</label>
              <input type="number" pInputText formControlName="vehiclesCheckedCount" placeholder="0" />
            </div>
            <div class="form-field">
              <label>Total Vehicles Passed</label>
              <input type="number" pInputText formControlName="vehiclesPassedCount" placeholder="0" />
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label>Log Date</label>
              <input
                type="date"
                pInputText
                formControlName="logDate"
                [max]="today | date:'yyyy-MM-dd'"
              />
            </div>
          </div>

          @if (isSelectedDateToday() && hasLogForToday()) {
            <div class="form-warning">
              <i class="pi pi-exclamation-triangle"></i>
              <span>A log is already recorded for today. Pick a previous date to add any missing entries.</span>
            </div>
          }

          <div class="form-footer">
            <p-button label="Discard" (onClick)="isLogModalVisible.set(false)" [text]="true" severity="secondary" />
            <p-button
              label="Finalize Entry"
              [loading]="isSavingLog()"
              icon="pi pi-check"
              (onClick)="saveLog()"
              [disabled]="logForm.invalid || (isSelectedDateToday() && hasLogForToday())"
            />
          </div>
        </form>
      </div>
    </p-dialog>

      <p-dialog
        header="Edit Checkpost"
        [(visible)]="isEditModalVisible"
        [modal]="true"
        [draggable]="false"
        [resizable]="false"
        styleClass="modern-dialog"
        [style]="{ width: '620px' }"
      >
        <form [formGroup]="editForm" class="edit-details-form">
          <div class="form-grid">
            <div class="form-field">
              <label>Checkpost Name</label>
              <input pInputText formControlName="name" />
            </div>
            <div class="form-field">
              <label>Circle</label>
              <input pInputText formControlName="circle" />
            </div>
            <div class="form-field">
              <label>Division</label>
              <input pInputText formControlName="division" />
            </div>
            <div class="form-field">
              <label>Range</label>
              <input pInputText formControlName="range" />
            </div>
            <div class="form-field">
              <label>Contact Number</label>
              <input pInputText formControlName="phoneNumber" />
            </div>
            <div class="form-field full-width">
              <label>Address</label>
              <textarea class="p-inputtext" formControlName="address" rows="3"></textarea>
            </div>
            <div class="form-field full-width">
              <label>Additional Notes</label>
              <textarea class="p-inputtext" formControlName="othersDetails" rows="3"></textarea>
            </div>
          </div>
          <div class="form-footer">
            <p-button label="Cancel" (onClick)="isEditModalVisible.set(false)" [text]="true" severity="secondary"></p-button>
            <p-button
              label="Save"
              styleClass="btn-primary"
              [loading]="isSavingEdit()"
              (onClick)="saveDetails()"
              [disabled]="editForm.invalid"
            ></p-button>
          </div>
        </form>
      </p-dialog>
  }
</div>

<p-toast />
